AWSTemplateFormatVersion: "2010-09-09"
Transform:
  - AWS::Serverless-2016-10-31
  - AWS::LanguageExtensions # for Fn::ToJsonString, see https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/intrinsic-function-reference-ToJsonString.html
Description: >
  sam-chat-boilerplate

  SAM Template for WebSocket based LLM chat application
  using AWS API Gateway WebSocket API and Lambda.

Parameters:
  WebSocketAPIName:
    Type: String
    Default: SamChatWebSocketAPI
    Description: (Required) The name of the API Gateway WebSocket API.

# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Handler: app.handler
    Runtime: python3.12
    # the timeout of the API Gateway WebSocket proxy integration is 29s
    # but we use Lambda async invocation for llm related functions
    # so it's safe to set this greater than 29
    Timeout: 300
    MemorySize: 512
    EphemeralStorage: 
      Size: 1024

Resources:
  # websocket api
  WebSocketAPI:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Ref WebSocketAPIName
      ProtocolType: WEBSOCKET
      RouteSelectionExpression: "$request.body.action"
  # TODO: auto re-deploy
  WebSocketAPIDeployment:
    Type: AWS::ApiGatewayV2::Deployment
    DependsOn:
      - LangChainFireworksMixtralMoE8x7BInstructRoute
      - LangChainDeepinfraMixtral822BInstructRoute
      - LangChainDeepinfraDolphin26mixtral8x7bRoute
      - LangChainDeepinfraWizardLM27BRoute
      - LangChainDeepinfraWizardLM2822BRoute
      - LangChainInfermaticMiquMaidV370BRoute
      - LangChainMistralMediumRoute
      - LangChainBedrockRoute
      - LangChainOpenAIRoute
      - BedrockRoute
      - OnConnectRoute
      - OnDefaultRoute
      - OnDisconnectRoute
    Properties:
      ApiId: !Ref WebSocketAPI
  WebSocketAPIProductionStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      StageName: Production
      DeploymentId: !Ref WebSocketAPIDeployment
      ApiId: !Ref WebSocketAPI

  ChatSetting:
    Type: AWS::Serverless::SimpleTable
    DeletionPolicy: Retain
    Properties:
      PrimaryKey:
        Name: uid
        Type: String

  UserMessages:
    Type: AWS::Serverless::SimpleTable
    DeletionPolicy: Retain
    Properties:
      PrimaryKey:
        Name: uid
        Type: String

  CharacterMessages:
    Type: AWS::Serverless::SimpleTable
    DeletionPolicy: Retain
    Properties:
      PrimaryKey:
        Name: cid
        Type: String
    GlobalSecondaryIndexes:
      - IndexName: UpdateFlagIndex
        KeySchema:
          - AttributeName: updateFlag
            KeyType: HASH  # 或者使用 RANGE 根据查询需求，HASH 用于唯一标识，RANGE 用于排序
        Projection:
          ProjectionType: ALL  # 或者使用 KEYS_ONLY / INCLUDE 根据实际需求定义投影类型
        ProvisionedThroughput:
          ReadCapacityUnits: 5   # 根据预期查询量设定读吞吐量
          WriteCapacityUnits: 5  # 根据索引更新频率设定写吞吐量


  CharacterDefinition:
    Type: AWS::Serverless::SimpleTable
    DeletionPolicy: Retain
    Properties:
      PrimaryKey:
        Name: id
        Type: String

  SessionTable:
    Type: AWS::Serverless::SimpleTable
    DeletionPolicy: Retain
    Properties:
      PrimaryKey:
        Name: SessionId
        Type: String

  # langchain/bedrock
  LangChainBedrockRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/bedrock
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainBedrockIntegration
  LangChainBedrockIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS # use non-proxy integration to invoke lambda async
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainBedrockFunction.Arn}/invocations
      RequestParameters:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-integration-async.html
        &AsyncLambdaIntegrationRequestParameters
        integration.request.header.X-Amz-Invocation-Type: "'Event'"
      RequestTemplates:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-websocket-api-mapping-template-reference.html
        &AsyncLambdaIntegrationRequestTemplates
        application/json: |
          {
            "requestContext": {
              "domainName": "$context.domainName",
              "stage": "$context.stage",
              "connectionId": "$context.connectionId"
            },
            "body": $input.body
          }
  LangChainBedrockFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/bedrock/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          SessionTableName: !Ref SessionTable
          CDTableName: !Ref CharacterDefinition
          CMTableName: !Ref CharacterMessages
          UMTableName: !Ref UserMessages
          ChatSettingTableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
  LangChainBedrockPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
      - CharacterDefinition
      - CharacterMessages
      - UserMessages
      - ChatSetting
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainBedrockFunction
      Principal: apigateway.amazonaws.com

  # langchain/openai
  LangChainOpenAIRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/openai
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainOpenAIIntegration
  LangChainOpenAIIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainOpenAIFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainOpenAIFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/openai/
      Layers:
        - !Ref LangChainCommonLayer
      Environment:
        Variables:
          OpenAI_API_Base: http://neural-chat-q5-114160182.us-west-2.elb.amazonaws.com/v1
          OpenAI_API_Key: "123"
          SessionTableName: !Ref SessionTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  LangChainOpenAIPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainOpenAIFunction
      Principal: apigateway.amazonaws.com



  # langchain/mistral/medium
  LangChainMistralMediumRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/mistral/medium
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainMistralMediumIntegration
  LangChainMistralMediumIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainMistralMediumFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainMistralMediumFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/mistral/
      Layers:
        - !Ref LangChainCommonLayer
      Environment:
        Variables:
          Mistral_API_Base: "https://api.mistral.ai/v1/chat/completions"
          Mistral_API_Key: "pv1Rl69upV9DiOVAlBVfhwUCmCJXfVe0"
          Mistral_Model_Name: "mistral-medium"
          SessionTableName: !Ref SessionTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  LangChainMistralMediumPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainMistralMediumFunction
      Principal: apigateway.amazonaws.com




   # langchain/infermatic/MiquMaid-v3-70B
  LangChainInfermaticMiquMaidV370BRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/infermatic/MiquMaid-v3-70B
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainInfermaticMiquMaidV370BIntegration
  LangChainInfermaticMiquMaidV370BIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainInfermaticMiquMaidV370BFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainInfermaticMiquMaidV370BFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/infermatic/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          OpenAI_Organization: "infermatic"
          OpenAI_API_Base: "https://api.totalgpt.ai/v1"
          OpenAI_API_Key: "sk-TpOemIuP3Wio2d3AeVeroA"
          Model_Name: "MiquMaid-v3-70B"
          SessionTableName: !Ref SessionTable
          CDTableName: !Ref CharacterDefinition
          CMTableName: !Ref CharacterMessages
          UMTableName: !Ref UserMessages
          ChatSettingTableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
  LangChainInfermaticMiquMaidV370BPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
      - CharacterDefinition
      - CharacterMessages
      - UserMessages
      - ChatSetting
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainInfermaticMiquMaidV370BFunction
      Principal: apigateway.amazonaws.com


  # langchain/deepinfra/Mixtral-8x22B-Instruct
  LangChainDeepinfraMixtral822BInstructRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/deepinfra/Mixtral-8x22B-Instruct
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainDeepinfraMixtral822BInstructIntegration
  LangChainDeepinfraMixtral822BInstructIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainDeepinfraMixtral822BInstructFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainDeepinfraMixtral822BInstructFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/deepinfra/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
        - !Ref NltkLayer
      Environment:
        Variables:
          API_Base: "https://api.deepinfra.com/v1/openai"
          API_Key: "1iubpJyGRvVCwIcbwaamAro95AqWR9mE"
          Model_Name: "mistralai/Mixtral-8x22B-Instruct-v0.1"
          SessionTableName: !Ref SessionTable
          CDTableName: !Ref CharacterDefinition
          CMTableName: !Ref CharacterMessages
          UMTableName: !Ref UserMessages
          ChatSettingTableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
  LangChainDeepinfraMixtral822BInstructPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
      - CharacterDefinition
      - CharacterMessages
      - UserMessages
      - ChatSetting
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainDeepinfraMixtral822BInstructFunction
      Principal: apigateway.amazonaws.com



  # langchain/deepinfra/dolphin-2.6-mixtral-8x7b
  LangChainDeepinfraDolphin26mixtral8x7bRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/deepinfra/dolphin-2.6-mixtral-8x7b
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainDeepinfraDolphin26mixtral8x7bIntegration
  LangChainDeepinfraDolphin26mixtral8x7bIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainDeepinfraDolphin26mixtral8x7bFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainDeepinfraDolphin26mixtral8x7bFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/deepinfra/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
        - !Ref NltkLayer
      Environment:
        Variables:
          API_Base: "https://api.deepinfra.com/v1/openai"
          API_Key: "1iubpJyGRvVCwIcbwaamAro95AqWR9mE"
          Model_Name: "cognitivecomputations/dolphin-2.6-mixtral-8x7b"
          SessionTableName: !Ref SessionTable
          CDTableName: !Ref CharacterDefinition
          CMTableName: !Ref CharacterMessages
          UMTableName: !Ref UserMessages
          ChatSettingTableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
  LangChainDeepinfraDolphin26mixtral8x7bPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
      - CharacterDefinition
      - CharacterMessages
      - UserMessages
      - ChatSetting
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainDeepinfraDolphin26mixtral8x7bFunction
      Principal: apigateway.amazonaws.com



   # langchain/deepinfra/WizardLM-2-7B
  LangChainDeepinfraWizardLM27BRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/deepinfra/WizardLM-2-7B
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainDeepinfraWizardLM27BIntegration
  LangChainDeepinfraWizardLM27BIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainDeepinfraWizardLM27BFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainDeepinfraWizardLM27BFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/deepinfra/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
        - !Ref NltkLayer
      Environment:
        Variables:
          API_Base: "https://api.deepinfra.com/v1/openai"
          API_Key: "1iubpJyGRvVCwIcbwaamAro95AqWR9mE"
          Model_Name: "microsoft/WizardLM-2-7B"
          SessionTableName: !Ref SessionTable
          CDTableName: !Ref CharacterDefinition
          CMTableName: !Ref CharacterMessages
          UMTableName: !Ref UserMessages
          ChatSettingTableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
        # - S3ReadPolicy:
        #     BucketName: daais3/tools
        #     Actions:
        #       - s3:GetObject 
  LangChainDeepinfraWizardLM27BPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
      - CharacterDefinition
      - CharacterMessages
      - UserMessages
      - ChatSetting
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainDeepinfraWizardLM27BFunction
      Principal: apigateway.amazonaws.com



  # langchain/deepinfra/WizardLM-2-8x22B
  LangChainDeepinfraWizardLM2822BRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/deepinfra/WizardLM-2-8x22B
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainDeepinfraWizardLM2822BIntegration
  LangChainDeepinfraWizardLM2822BIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainDeepinfraWizardLM2822BFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainDeepinfraWizardLM2822BFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/deepinfra/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
        - !Ref NltkLayer
      Environment:
        Variables:
          API_Base: "https://api.deepinfra.com/v1/openai"
          API_Key: "1iubpJyGRvVCwIcbwaamAro95AqWR9mE"
          Model_Name: "microsoft/WizardLM-2-8x22B"
          SessionTableName: !Ref SessionTable
          CDTableName: !Ref CharacterDefinition
          CMTableName: !Ref CharacterMessages
          UMTableName: !Ref UserMessages
          ChatSettingTableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
  LangChainDeepinfraWizardLM2822BPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
      - CharacterDefinition
      - CharacterMessages
      - UserMessages
      - ChatSetting
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainDeepinfraWizardLM2822BFunction
      Principal: apigateway.amazonaws.com



       # langchain/fireworks/Mixtral-MoE-8x7B-Instruct
  LangChainFireworksMixtralMoE8x7BInstructRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: langchain/fireworks/Mixtral-MoE-8x7B-Instruct
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref LangChainFireworksMixtralMoE8x7BInstructIntegration
  LangChainFireworksMixtralMoE8x7BInstructIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${LangChainFireworksMixtralMoE8x7BInstructFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  LangChainFireworksMixtralMoE8x7BInstructFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: langchain/fireworks/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          API_Base: "https://api.fireworks.ai/inference/v1/chat/completions"
          API_Key: "WglavV6hm0RLeZohaDZcrEjGAedu04GnJbDazBJ2PzmY7nRl"
          Model_Name: "accounts/fireworks/models/mixtral-8x7b-instruct"
          SessionTableName: !Ref SessionTable
          CDTableName: !Ref CharacterDefinition
          CMTableName: !Ref CharacterMessages
          UMTableName: !Ref UserMessages
          ChatSettingTableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
  LangChainFireworksMixtralMoE8x7BInstructPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
      - CharacterDefinition
      - CharacterMessages
      - UserMessages
      - ChatSetting
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref LangChainFireworksMixtralMoE8x7BInstructFunction
      Principal: apigateway.amazonaws.com




      # ModifyCharacterDefinitionRoute
  ModifyCharacterDefinitionFunction:
    Type: AWS::Serverless::Function
    DeletionPolicy: Retain
    Properties:
      CodeUri: game/modify-character-definition/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          SessionTableName: !Ref CharacterDefinition
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterDefinition
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  ModifyCharacterDefinitionPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Retain
    DependsOn:
      - WebSocketAPI
      - CharacterDefinition
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ModifyCharacterDefinitionFunction
      Principal: apigateway.amazonaws.com

  # SyncCharacterMessages
  SyncCharacterMessagesFunction:
    Type: AWS::Serverless::Function
    DeletionPolicy: Retain
    Properties:
      CodeUri: game/sync-character-messages/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          CMTableName: !Ref CharacterMessages
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CharacterMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  SyncCharacterMessagesPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Retain
    DependsOn:
      - WebSocketAPI
      - CharacterDefinition
      - CharacterMessages
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref SyncCharacterMessagesFunction
      Principal: apigateway.amazonaws.com

  # GetUserMessages
  GetUserMessagesFunction:
    Type: AWS::Serverless::Function
    DeletionPolicy: Retain
    Properties:
      CodeUri: game/get-user-messages/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          UMTableName: !Ref UserMessages
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  GetUserMessagesPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Retain
    DependsOn:
      - WebSocketAPI
      - UserMessages
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref GetUserMessagesFunction
      Principal: apigateway.amazonaws.com

  # ModifyUserMessages
  ModifyUserMessagesFunction:
    Type: AWS::Serverless::Function
    DeletionPolicy: Retain
    Properties:
      CodeUri: game/modify-user-messages/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          UMTableName: !Ref UserMessages
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UserMessages
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  ModifyUserMessagesPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Retain
    DependsOn:
      - WebSocketAPI
      - UserMessages
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ModifyUserMessagesFunction
      Principal: apigateway.amazonaws.com

  # DeleteLogMessagesFromHistory
  DeleteLogMessagesFromHistoryFunction:
    Type: AWS::Serverless::Function
    DeletionPolicy: Retain
    Properties:
      CodeUri: game/delete-log-message-from-history/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          TableName: !Ref SessionTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  DeleteLogMessagesFromHistoryPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Retain
    DependsOn:
      - WebSocketAPI
      - SessionTable
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref DeleteLogMessagesFromHistoryFunction
      Principal: apigateway.amazonaws.com


  # CreateChatFromSaved
  CreateChatFromSavedFunction:
    Type: AWS::Serverless::Function
    DeletionPolicy: Retain
    Properties:
      CodeUri: game/create-chat-from-saved/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          TableName: !Ref SessionTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  CreateChatFromSavedPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Retain
    DependsOn:
      - WebSocketAPI
      - SessionTable
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref CreateChatFromSavedFunction
      Principal: apigateway.amazonaws.com

   # ModifyChatSetting
  ModifyChatSettingFunction:
    Type: AWS::Serverless::Function
    DeletionPolicy: Retain
    Properties:
      CodeUri: game/modify-chat-setting/
      Layers:
        - !Ref LangChainCommonLayer
        - !Ref CommonLayer
      Environment:
        Variables:
          TableName: !Ref ChatSetting
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ChatSetting
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
  ModifyChatSettingPermission:
    Type: AWS::Lambda::Permission
    DeletionPolicy: Retain
    DependsOn:
      - WebSocketAPI
      - SessionTable
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref ModifyChatSettingFunction
      Principal: apigateway.amazonaws.com

  # bedrock
  BedrockRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: bedrock
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref BedrockIntegration
  BedrockIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${BedrockFunction.Arn}/invocations
      RequestParameters: *AsyncLambdaIntegrationRequestParameters
      RequestTemplates: *AsyncLambdaIntegrationRequestTemplates
  BedrockFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: bedrock/
      Environment:
        Variables:
          SessionTableName: !Ref SessionTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionTable
        - Statement:
            - Effect: Allow
              Action:
                - "execute-api:ManageConnections"
              Resource:
                - !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${WebSocketAPI}/*"
            - Effect: Allow
              Action:
                - "bedrock:InvokeModel"
                - "bedrock:InvokeModelWithResponseStream"
              Resource:
                - "arn:aws:bedrock:*::foundation-model/*"
  BedrockPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
      - SessionTable
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref BedrockFunction
      Principal: apigateway.amazonaws.com

  # $connect
  OnConnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: $connect
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref OnConnectIntegration
  OnConnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS_PROXY
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${OnConnectFunction.Arn}/invocations
  OnConnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: connect/
  OnConnectPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref OnConnectFunction
      Principal: apigateway.amazonaws.com

  # $disconnect
  OnDisconnectRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: $disconnect
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref OnDisconnectIntegration
  OnDisconnectIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS_PROXY
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${OnDisconnectFunction.Arn}/invocations
  OnDisconnectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: disconnect/
  OnDisconnectPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref OnDisconnectFunction
      Principal: apigateway.amazonaws.com

  # $default
  OnDefaultRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteKey: $default
      AuthorizationType: NONE
      Target: !Join
        - "/"
        - - "integrations"
          - !Ref OnDefaultIntegration
  OnDefaultIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref WebSocketAPI
      IntegrationType: AWS_PROXY
      IntegrationUri:
        # see https://docs.aws.amazon.com/apigateway/latest/developerguide/set-up-lambda-proxy-integrations.html
        Fn::Sub: arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${OnDefaultFunction.Arn}/invocations
  OnDefaultRouteResponse:
    Type: AWS::ApiGatewayV2::RouteResponse
    Properties:
      ApiId: !Ref WebSocketAPI
      RouteId: !Ref OnDefaultRoute
      RouteResponseKey: $default
  OnDefaultFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: default/
  OnDefaultPermission:
    Type: AWS::Lambda::Permission
    DependsOn:
      - WebSocketAPI
    Properties:
      Action: lambda:InvokeFunction
      FunctionName: !Ref OnDefaultFunction
      Principal: apigateway.amazonaws.com


  # nltk layer
  NltkLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: layer/nltk/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: python3.12

  # lambda layer
  LangChainCommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: layer/langchain_common/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: python3.12

  # common layer
  CommonLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      ContentUri: layer/common/
      CompatibleRuntimes:
        - python3.12
    Metadata:
      BuildMethod: python3.12

Outputs:
  WebSocketAPIEndpoint:
    Value:
      !Join [
        "",
        [
          "wss://",
          !Ref WebSocketAPI,
          ".execute-api.",
          !Ref "AWS::Region",
          ".amazonaws.com/",
          !Ref "WebSocketAPIProductionStage",
        ],
      ]